# finanalyst_tools/calculations/profitability.py
"""
Profitability ratio calculations.

Provides calculations for:
- Gross Profit Margin
- Operating Profit Margin
- Net Profit Margin
- EBITDA Margin
- Return on Assets (ROA)
- Return on Equity (ROE)
- Return on Capital Employed (ROCE)
"""

from __future__ import annotations

from decimal import Decimal
from typing import Any

from finanalyst_tools.config import METRIC_FORMULAS, PlausibilityRanges
from finanalyst_tools.models.analysis_results import (
    CalculationResult,
    MetricUnit,
    MetricCategory,
    MetricCollection,
)
from finanalyst_tools.models.financial_statements import (
    IncomeStatementData,
    BalanceSheetData,
    FinancialStatementSet,
)
from finanalyst_tools.calculations.base import (
    BaseCalculator,
    create_calculation_result,
    extract_value,
)
from finanalyst_tools.utils.math_ops import (
    to_decimal,
    safe_divide,
    round_decimal,
    calculate_percentage,
    calculate_average,
    is_effectively_zero,
)


# ============================================================================
# STANDALONE CALCULATION FUNCTIONS
# ============================================================================

def calculate_gross_profit_margin(
    revenue: Decimal | float | int,
    cost_of_goods_sold: Decimal | float | int,
) -> CalculationResult:
    """
    Calculate Gross Profit Margin.
    
    Formula: (Revenue - COGS) / Revenue × 100
    
    Args:
        revenue: Total revenue
        cost_of_goods_sold: Cost of goods sold
        
    Returns:
        CalculationResult with gross profit margin percentage
    """
    steps = []
    warnings = []
    
    # Convert inputs
    rev = to_decimal(revenue)
    cogs = to_decimal(cost_of_goods_sold)
    
    steps.append(f"Revenue = {rev:,.2f}")
    steps.append(f"COGS = {cogs:,.2f}")
    
    # Calculate gross profit
    gross_profit = rev - cogs
    steps.append(f"Gross Profit = Revenue - COGS = {rev:,.2f} - {cogs:,.2f} = {gross_profit:,.2f}")
    
    # Check for zero revenue
    if is_effectively_zero(rev):
        warnings.append("Revenue is zero, cannot calculate margin")
        return create_calculation_result(
            metric_name="Gross Profit Margin",
            value=None,
            formula=METRIC_FORMULAS.get("gross_profit_margin", "(Revenue - COGS) / Revenue × 100"),
            inputs={"revenue": float(rev), "cost_of_goods_sold": float(cogs)},
            steps=steps,
            category=MetricCategory.PROFITABILITY,
            warnings=warnings,
        )
    
    # Calculate margin
    margin = calculate_percentage(gross_profit, rev)
    steps.append(f"Gross Profit Margin = (Gross Profit / Revenue) × 100 = ({gross_profit:,.2f} / {rev:,.2f}) × 100 = {margin:.2f}%")
    
    # Add contextual warnings
    if margin < Decimal("0"):
        warnings.append("Negative gross margin indicates selling below cost")
    elif margin > Decimal("90"):
        warnings.append("Very high gross margin - verify COGS is complete")
    
    return create_calculation_result(
        metric_name="Gross Profit Margin",
        value=margin,
        formula=METRIC_FORMULAS.get("gross_profit_margin", "(Revenue - COGS) / Revenue × 100"),
        inputs={"revenue": float(rev), "cost_of_goods_sold": float(cogs), "gross_profit": float(gross_profit)},
        steps=steps,
        category=MetricCategory.PROFITABILITY,
        warnings=warnings,
    )


def calculate_operating_profit_margin(
    revenue: Decimal | float | int,
    cost_of_goods_sold: Decimal | float | int,
    operating_expenses: Decimal | float | int,
    marketing_expenses: Decimal | float | int | None = None,
    include_marketing_in_opex: bool = True,
) -> CalculationResult:
    """
    Calculate Operating Profit Margin.
    
    Formula: (Revenue - COGS - OpEx) / Revenue × 100
    
    Args:
        revenue: Total revenue
        cost_of_goods_sold: Cost of goods sold
        operating_expenses: Operating expenses
        marketing_expenses: Marketing expenses (optional, if tracked separately)
        include_marketing_in_opex: Whether marketing is already in OpEx
        
    Returns:
        CalculationResult with operating profit margin percentage
    """
    steps = []
    warnings = []
    
    # Convert inputs
    rev = to_decimal(revenue)
    cogs = to_decimal(cost_of_goods_sold)
    opex = to_decimal(operating_expenses)
    marketing = to_decimal(marketing_expenses) if marketing_expenses else Decimal("0")
    
    steps.append(f"Revenue = {rev:,.2f}")
    steps.append(f"COGS = {cogs:,.2f}")
    steps.append(f"Operating Expenses = {opex:,.2f}")
    
    # Handle marketing separately if needed
    total_opex = opex
    if marketing_expenses and not include_marketing_in_opex:
        total_opex = opex + marketing
        steps.append(f"Marketing Expenses = {marketing:,.2f} (added separately)")
        steps.append(f"Total Operating Expenses = {total_opex:,.2f}")
    
    # Calculate operating profit
    gross_profit = rev - cogs
    operating_profit = gross_profit - total_opex
    steps.append(f"Gross Profit = {gross_profit:,.2f}")
    steps.append(f"Operating Profit = Gross Profit - OpEx = {gross_profit:,.2f} - {total_opex:,.2f} = {operating_profit:,.2f}")
    
    # Check for zero revenue
    if is_effectively_zero(rev):
        warnings.append("Revenue is zero, cannot calculate margin")
        return create_calculation_result(
            metric_name="Operating Profit Margin",
            value=None,
            formula=METRIC_FORMULAS.get("operating_profit_margin", "(Revenue - COGS - OpEx) / Revenue × 100"),
            inputs={
                "revenue": float(rev),
                "cost_of_goods_sold": float(cogs),
                "operating_expenses": float(total_opex),
            },
            steps=steps,
            category=MetricCategory.PROFITABILITY,
            warnings=warnings,
        )
    
    # Calculate margin
    margin = calculate_percentage(operating_profit, rev)
    steps.append(f"Operating Profit Margin = (Operating Profit / Revenue) × 100 = {margin:.2f}%")
    
    # Contextual warnings
    if margin < Decimal("-50"):
        warnings.append("Severely negative operating margin - company may be in distress")
    
    return create_calculation_result(
        metric_name="Operating Profit Margin",
        value=margin,
        formula=METRIC_FORMULAS.get("operating_profit_margin", "(Revenue - COGS - OpEx) / Revenue × 100"),
        inputs={
            "revenue": float(rev),
            "cost_of_goods_sold": float(cogs),
            "operating_expenses": float(total_opex),
            "operating_profit": float(operating_profit),
        },
        steps=steps,
        category=MetricCategory.PROFITABILITY,
        warnings=warnings,
    )


def calculate_net_profit_margin(
    revenue: Decimal | float | int,
    net_income: Decimal | float | int,
) -> CalculationResult:
    """
    Calculate Net Profit Margin.
    
    Formula: Net Income / Revenue × 100
    
    Args:
        revenue: Total revenue
        net_income: Net income (after tax)
        
    Returns:
        CalculationResult with net profit margin percentage
    """
    steps = []
    warnings = []
    
    rev = to_decimal(revenue)
    ni = to_decimal(net_income)
    
    steps.append(f"Revenue = {rev:,.2f}")
    steps.append(f"Net Income = {ni:,.2f}")
    
    if is_effectively_zero(rev):
        warnings.append("Revenue is zero, cannot calculate margin")
        return create_calculation_result(
            metric_name="Net Profit Margin",
            value=None,
            formula=METRIC_FORMULAS.get("net_profit_margin", "Net Income / Revenue × 100"),
            inputs={"revenue": float(rev), "net_income": float(ni)},
            steps=steps,
            category=MetricCategory.PROFITABILITY,
            warnings=warnings,
        )
    
    margin = calculate_percentage(ni, rev)
    steps.append(f"Net Profit Margin = (Net Income / Revenue) × 100 = ({ni:,.2f} / {rev:,.2f}) × 100 = {margin:.2f}%")
    
    # Warnings
    if margin > Decimal("50"):
        warnings.append("Net margin >50% is unusual - verify data accuracy")
    if margin < Decimal("-100"):
        warnings.append("Net losses exceed revenue - severe financial distress")
    
    return create_calculation_result(
        metric_name="Net Profit Margin",
        value=margin,
        formula=METRIC_FORMULAS.get("net_profit_margin", "Net Income / Revenue × 100"),
        inputs={"revenue": float(rev), "net_income": float(ni)},
        steps=steps,
        category=MetricCategory.PROFITABILITY,
        warnings=warnings,
    )


def calculate_ebitda_margin(
    revenue: Decimal | float | int,
    ebitda: Decimal | float | int,
) -> CalculationResult:
    """
    Calculate EBITDA Margin.
    
    Formula: EBITDA / Revenue × 100
    
    Args:
        revenue: Total revenue
        ebitda: Earnings Before Interest, Taxes, Depreciation, and Amortization
        
    Returns:
        CalculationResult with EBITDA margin percentage
    """
    steps = []
    warnings = []
    
    rev = to_decimal(revenue)
    ebitda_val = to_decimal(ebitda)
    
    steps.append(f"Revenue = {rev:,.2f}")
    steps.append(f"EBITDA = {ebitda_val:,.2f}")
    
    if is_effectively_zero(rev):
        warnings.append("Revenue is zero, cannot calculate margin")
        return create_calculation_result(
            metric_name="EBITDA Margin",
            value=None,
            formula=METRIC_FORMULAS.get("ebitda_margin", "EBITDA / Revenue × 100"),
            inputs={"revenue": float(rev), "ebitda": float(ebitda_val)},
            steps=steps,
            category=MetricCategory.PROFITABILITY,
            warnings=warnings,
        )
    
    margin = calculate_percentage(ebitda_val, rev)
    steps.append(f"EBITDA Margin = (EBITDA / Revenue) × 100 = ({ebitda_val:,.2f} / {rev:,.2f}) × 100 = {margin:.2f}%")
    
    return create_calculation_result(
        metric_name="EBITDA Margin",
        value=margin,
        formula=METRIC_FORMULAS.get("ebitda_margin", "EBITDA / Revenue × 100"),
        inputs={"revenue": float(rev), "ebitda": float(ebitda_val)},
        steps=steps,
        category=MetricCategory.PROFITABILITY,
        warnings=warnings,
    )


def calculate_return_on_assets(
    net_income: Decimal | float | int,
    total_assets_beginning: Decimal | float | int,
    total_assets_ending: Decimal | float | int,
) -> CalculationResult:
    """
    Calculate Return on Assets (ROA).
    
    Formula: Net Income / Average Total Assets × 100
    
    Args:
        net_income: Net income for the period
        total_assets_beginning: Total assets at beginning of period
        total_assets_ending: Total assets at end of period
        
    Returns:
        CalculationResult with ROA percentage
    """
    steps = []
    warnings = []
    
    ni = to_decimal(net_income)
    assets_begin = to_decimal(total_assets_beginning)
    assets_end = to_decimal(total_assets_ending)
    
    steps.append(f"Net Income = {ni:,.2f}")
    steps.append(f"Total Assets (Beginning) = {assets_begin:,.2f}")
    steps.append(f"Total Assets (Ending) = {assets_end:,.2f}")
    
    # Calculate average assets
    avg_assets = calculate_average(assets_begin, assets_end)
    steps.append(f"Average Total Assets = ({assets_begin:,.2f} + {assets_end:,.2f}) / 2 = {avg_assets:,.2f}")
    
    if is_effectively_zero(avg_assets):
        warnings.append("Average assets is zero, cannot calculate ROA")
        return create_calculation_result(
            metric_name="Return on Assets",
            value=None,
            formula=METRIC_FORMULAS.get("roa", "Net Income / Average Total Assets × 100"),
            inputs={
                "net_income": float(ni),
                "total_assets_beginning": float(assets_begin),
                "total_assets_ending": float(assets_end),
            },
            steps=steps,
            category=MetricCategory.PROFITABILITY,
            warnings=warnings,
        )
    
    roa = calculate_percentage(ni, avg_assets)
    steps.append(f"ROA = (Net Income / Average Assets) × 100 = ({ni:,.2f} / {avg_assets:,.2f}) × 100 = {roa:.2f}%")
    
    # Warnings
    if avg_assets != assets_end:
        steps.append("Note: Using average assets for more accurate return calculation")
    
    return create_calculation_result(
        metric_name="Return on Assets",
        value=roa,
        formula=METRIC_FORMULAS.get("roa", "Net Income / Average Total Assets × 100"),
        inputs={
            "net_income": float(ni),
            "total_assets_beginning": float(assets_begin),
            "total_assets_ending": float(assets_end),
            "average_total_assets": float(avg_assets),
        },
        steps=steps,
        category=MetricCategory.PROFITABILITY,
        warnings=warnings,
    )


def calculate_return_on_equity(
    net_income: Decimal | float | int,
    shareholders_equity_beginning: Decimal | float | int,
    shareholders_equity_ending: Decimal | float | int,
) -> CalculationResult:
    """
    Calculate Return on Equity (ROE).
    
    Formula: Net Income / Average Shareholders' Equity × 100
    
    Args:
        net_income: Net income for the period
        shareholders_equity_beginning: Equity at beginning of period
        shareholders_equity_ending: Equity at end of period
        
    Returns:
        CalculationResult with ROE percentage
    """
    steps = []
    warnings = []
    
    ni = to_decimal(net_income)
    equity_begin = to_decimal(shareholders_equity_beginning)
    equity_end = to_decimal(shareholders_equity_ending)
    
    steps.append(f"Net Income = {ni:,.2f}")
    steps.append(f"Shareholders' Equity (Beginning) = {equity_begin:,.2f}")
    steps.append(f"Shareholders' Equity (Ending) = {equity_end:,.2f}")
    
    # Calculate average equity
    avg_equity = calculate_average(equity_begin, equity_end)
    steps.append(f"Average Shareholders' Equity = ({equity_begin:,.2f} + {equity_end:,.2f}) / 2 = {avg_equity:,.2f}")
    
    # Check for negative equity
    if equity_end < 0:
        warnings.append("Negative shareholders' equity indicates accumulated losses exceed capital")
    
    if is_effectively_zero(avg_equity):
        warnings.append("Average equity is zero or near-zero, ROE calculation may be unreliable")
        return create_calculation_result(
            metric_name="Return on Equity",
            value=None,
            formula=METRIC_FORMULAS.get("roe", "Net Income / Average Shareholders' Equity × 100"),
            inputs={
                "net_income": float(ni),
                "shareholders_equity_beginning": float(equity_begin),
                "shareholders_equity_ending": float(equity_end),
            },
            steps=steps,
            category=MetricCategory.PROFITABILITY,
            warnings=warnings,
        )
    
    roe = calculate_percentage(ni, avg_equity)
    steps.append(f"ROE = (Net Income / Average Equity) × 100 = ({ni:,.2f} / {avg_equity:,.2f}) × 100 = {roe:.2f}%")
    
    return create_calculation_result(
        metric_name="Return on Equity",
        value=roe,
        formula=METRIC_FORMULAS.get("roe", "Net Income / Average Shareholders' Equity × 100"),
        inputs={
            "net_income": float(ni),
            "shareholders_equity_beginning": float(equity_begin),
            "shareholders_equity_ending": float(equity_end),
            "average_shareholders_equity": float(avg_equity),
        },
        steps=steps,
        category=MetricCategory.PROFITABILITY,
        warnings=warnings,
    )


def calculate_return_on_capital_employed(
    ebit: Decimal | float | int,
    total_assets: Decimal | float | int,
    current_liabilities: Decimal | float | int,
) -> CalculationResult:
    """
    Calculate Return on Capital Employed (ROCE).
    
    Formula: EBIT / (Total Assets - Current Liabilities) × 100
    
    Args:
        ebit: Earnings Before Interest and Taxes
        total_assets: Total assets
        current_liabilities: Current liabilities
        
    Returns:
        CalculationResult with ROCE percentage
    """
    steps = []
    warnings = []
    
    ebit_val = to_decimal(ebit)
    assets = to_decimal(total_assets)
    cl = to_decimal(current_liabilities)
    
    steps.append(f"EBIT = {ebit_val:,.2f}")
    steps.append(f"Total Assets = {assets:,.2f}")
    steps.append(f"Current Liabilities = {cl:,.2f}")
    
    # Calculate capital employed
    capital_employed = assets - cl
    steps.append(f"Capital Employed = Total Assets - Current Liabilities = {assets:,.2f} - {cl:,.2f} = {capital_employed:,.2f}")
    
    if is_effectively_zero(capital_employed):
        warnings.append("Capital employed is zero, cannot calculate ROCE")
        return create_calculation_result(
            metric_name="Return on Capital Employed",
            value=None,
            formula=METRIC_FORMULAS.get("roce", "EBIT / (Total Assets - Current Liabilities) × 100"),
            inputs={
                "ebit": float(ebit_val),
                "total_assets": float(assets),
                "current_liabilities": float(cl),
            },
            steps=steps,
            category=MetricCategory.PROFITABILITY,
            warnings=warnings,
        )
    
    roce = calculate_percentage(ebit_val, capital_employed)
    steps.append(f"ROCE = (EBIT / Capital Employed) × 100 = ({ebit_val:,.2f} / {capital_employed:,.2f}) × 100 = {roce:.2f}%")
    
    return create_calculation_result(
        metric_name="Return on Capital Employed",
        value=roce,
        formula=METRIC_FORMULAS.get("roce", "EBIT / (Total Assets - Current Liabilities) × 100"),
        inputs={
            "ebit": float(ebit_val),
            "total_assets": float(assets),
            "current_liabilities": float(cl),
            "capital_employed": float(capital_employed),
        },
        steps=steps,
        category=MetricCategory.PROFITABILITY,
        warnings=warnings,
    )


def calculate_all_profitability_metrics(
    income_statement: IncomeStatementData,
    balance_sheet: BalanceSheetData,
    prior_balance_sheet: BalanceSheetData | None = None,
) -> MetricCollection:
    """
    Calculate all profitability metrics.
    
    Args:
        income_statement: Current period income statement
        balance_sheet: Current period balance sheet
        prior_balance_sheet: Prior period balance sheet (for averages)
        
    Returns:
        MetricCollection with all profitability metrics
    """
    collection = MetricCollection(
        category=MetricCategory.PROFITABILITY,
        period=income_statement.period,
    )
    
    # Use current balance sheet for both if no prior available
    if prior_balance_sheet is None:
        prior_balance_sheet = balance_sheet
    
    # Gross Profit Margin
    gpm = calculate_gross_profit_margin(
        revenue=income_statement.total_revenue,
        cost_of_goods_sold=income_statement.cost_of_goods_sold,
    )
    collection.add_metric(gpm)
    
    # Operating Profit Margin
    opm = calculate_operating_profit_margin(
        revenue=income_statement.total_revenue,
        cost_of_goods_sold=income_statement.cost_of_goods_sold,
        operating_expenses=income_statement.total_operating_expenses,
    )
    collection.add_metric(opm)
    
    # Net Profit Margin
    npm = calculate_net_profit_margin(
        revenue=income_statement.total_revenue,
        net_income=income_statement.calculated_net_income,
    )
    collection.add_metric(npm)
    
    # EBITDA Margin
    ebitda_m = calculate_ebitda_margin(
        revenue=income_statement.total_revenue,
        ebitda=income_statement.ebitda,
    )
    collection.add_metric(ebitda_m)
    
    # ROA
    roa = calculate_return_on_assets(
        net_income=income_statement.calculated_net_income,
        total_assets_beginning=prior_balance_sheet.calculated_total_assets,
        total_assets_ending=balance_sheet.calculated_total_assets,
    )
    collection.add_metric(roa)
    
    # ROE
    roe = calculate_return_on_equity(
        net_income=income_statement.calculated_net_income,
        shareholders_equity_beginning=prior_balance_sheet.calculated_shareholders_equity,
        shareholders_equity_ending=balance_sheet.calculated_shareholders_equity,
    )
    collection.add_metric(roe)
    
    # ROCE
    roce = calculate_return_on_capital_employed(
        ebit=income_statement.ebit,
        total_assets=balance_sheet.calculated_total_assets,
        current_liabilities=balance_sheet.calculated_current_liabilities,
    )
    collection.add_metric(roce)
    
    return collection


class ProfitabilityCalculator(BaseCalculator):
    """Class-based calculator for profitability metrics."""
    
    def __init__(self):
        super().__init__(MetricCategory.PROFITABILITY)
    
    def calculate_all(
        self,
        statement_set: FinancialStatementSet,
        prior_statement_set: FinancialStatementSet | None = None,
    ) -> MetricCollection:
        """Calculate all profitability metrics."""
        prior_bs = prior_statement_set.balance_sheet if prior_statement_set else None
        
        return calculate_all_profitability_metrics(
            income_statement=statement_set.income_statement,
            balance_sheet=statement_set.balance_sheet,
            prior_balance_sheet=prior_bs,
        )
